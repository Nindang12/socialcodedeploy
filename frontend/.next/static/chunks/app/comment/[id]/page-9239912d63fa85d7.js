(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[742],{4845:(e,t,a)=>{Promise.resolve().then(a.bind(a,5544))},5544:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>x});var r=a(5155),o=a(2115),s=a(5695),l=a(3464);let n=(0,a(9946).A)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var i=a(1976),c=a(1366),d=a(1335),m=a(7213),u=a(9803),h=a(6874),p=a.n(h);function x(){var e;(0,s.useRouter)();let t=(0,s.useParams)().id,[a,h]=(0,o.useState)(""),[x,y]=(0,o.useState)(!1),[f,b]=(0,o.useState)(""),[j,w]=(0,o.useState)(!1),[k,_]=(0,o.useState)(0),[N,S]=(0,o.useState)(!1),[C,A]=(0,o.useState)(0),[E,I]=(0,o.useState)(0),[z,R]=(0,o.useState)(!1),[L,B]=(0,o.useState)({}),[T,O]=(0,o.useState)({}),[F,U]=(0,o.useState)({}),[P,D]=(0,o.useState)({}),[M,V]=(0,o.useState)({}),[H,G]=(0,o.useState)(null),[W,X]=(0,o.useState)(null),[q,J]=(0,o.useState)(null),[K,Q]=(0,o.useState)([]),[Y,Z]=(0,o.useState)({}),[$,ee]=(0,o.useState)({}),[et,ea]=(0,o.useState)(null),[er,eo]=(0,o.useState)(null),[es,el]=(0,o.useState)({}),[en,ei]=(0,o.useState)({}),[ec,ed]=(0,o.useState)({}),[em,eu]=(0,o.useState)(""),eh=async()=>{if(!a.trim()){eu("Vui l\xf2ng nhập nội dung b\xecnh luận!");return}eu("");try{let e=localStorage.getItem("token"),r=new FormData;r.append("content",a),et&&r.append("image",et),er&&r.append("video",er);let o=await fetch("http://127.0.0.1:8000/posts/".concat(t,"/comment"),{method:"POST",headers:{Authorization:"Bearer ".concat(e)},body:r});if(!o.ok)throw Error("Failed to comment");let s=await o.json();Q(e=>[...e,s]),ea(null),eo(null)}catch(e){console.error("Error commenting:",e)}},ep=async e=>{if(V(t=>({...t,[e]:!t[e]})),!F[e])try{let t=localStorage.getItem("token"),a=await fetch("http://127.0.0.1:8000/comments/".concat(e,"/replied"),{headers:{Authorization:"Bearer ".concat(t)}});if(a.ok){let t=await a.json();U(a=>({...a,[e]:t}))}}catch(e){console.error("Error fetching replies:",e)}},ex=async()=>{try{let a=localStorage.getItem("token"),r=await fetch("http://127.0.0.1:8000/posts/".concat(t,"/like"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)}});if(!r.ok)throw Error("Failed to like post");let o=await r.json();if(o&&o.liked_by&&q){var e;let t=o.liked_by.map(e=>String(e).trim()).includes(String(q.user_id).trim());w(t),_(null!==(e=o.likes)&&void 0!==e?e:0)}}catch(e){console.error("Error liking post:",e)}},eg=async()=>{try{let a=localStorage.getItem("token"),r=await fetch("http://127.0.0.1:8000/posts/".concat(t,"/repost"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)}});if(!r.ok)throw Error("Failed to repost");let o=await r.json();if(o&&o.reposted_by&&q){var e;let t=o.reposted_by.map(e=>String(e).trim()).includes(String(q.user_id).trim());S(t),A(null!==(e=o.reposts)&&void 0!==e?e:0)}}catch(e){console.error("Error reposting:",e)}},ev=async(e,t)=>{try{let e=localStorage.getItem("token"),a=new FormData;a.append("content",P[t]),en[t]&&a.append("image",en[t]),ec[t]&&a.append("video",ec[t]);let r=await fetch("http://127.0.0.1:8000/comments/".concat(t,"/reply"),{method:"POST",headers:{Authorization:"Bearer ".concat(e)},body:a});if(!r.ok)throw Error("Failed to reply");let o=await r.json();U(e=>({...e,[t]:[...e[t]||[],o]})),D(e=>({...e,[t]:""})),ei(e=>({...e,[t]:null})),ed(e=>({...e,[t]:null}))}catch(e){console.error("Error replying:",e)}},ey=async e=>{try{let t=localStorage.getItem("token"),a=await fetch("http://127.0.0.1:8000/comments/".concat(e,"/like"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)}});if(!a.ok)throw Error("Failed to like comment");let r=await a.json(),o=r.liked_by.map(e=>String(e).trim()).includes(String(q.user_id).trim());Z(t=>({...t,[e]:o})),ee(t=>{var a;return{...t,[e]:null!==(a=r.likes)&&void 0!==a?a:0}})}catch(e){console.error("Error liking comment:",e)}},ef=async e=>{try{let t=localStorage.getItem("token"),a=await fetch("http://127.0.0.1:8000/comments/".concat(e,"/replied"),{headers:{Authorization:"Bearer ".concat(t)}});if(a.ok){let t=await a.json();U(a=>({...a,[e]:t}))}}catch(e){console.error("Error fetching replies:",e)}};function eb(e){let t=new Date,a=new Date(e),r=Math.floor((t.getTime()-a.getTime())/6e4);if(r<1)return"vừa xong";if(r<60)return"".concat(r," ph\xfat");if(r<1440){let e=Math.floor(r/60);return"".concat(e," giờ")}{let e=Math.floor(r/1440);return"".concat(e," ng\xe0y")}}(0,o.useEffect)(()=>{(async()=>{try{var e,a,r,o;let s=localStorage.getItem("token"),n=await l.A.get("http://127.0.0.1:8000/posts/".concat(t),{headers:{Authorization:"Bearer ".concat(s)}});if(G(n.data),n.data.liked_by&&q){let t=n.data.liked_by.map(e=>String(e).trim()).includes(String(q.user_id).trim());w(t),_(null!==(e=n.data.likes)&&void 0!==e?e:0)}else w(!1),_(null!==(a=n.data.likes)&&void 0!==a?a:0);if(n.data.reposted_by&&q){let e=n.data.reposted_by.map(e=>String(e).trim()).includes(String(q.user_id).trim());S(e),A(null!==(r=n.data.reposts)&&void 0!==r?r:0)}else S(!1),A(null!==(o=n.data.reposts)&&void 0!==o?o:0)}catch(e){console.error("Error fetching post:",e)}})()},[t,q]),(0,o.useEffect)(()=>{(null==H?void 0:H.user_id)&&(async()=>{try{let e=localStorage.getItem("token"),t=await l.A.get("http://127.0.0.1:8000/users/".concat(H.user_id),{headers:{Authorization:"Bearer ".concat(e)}});X(t.data.user)}catch(e){console.error("Error fetching user:",e)}})()},[H]),(0,o.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("token"),t=await l.A.get("http://127.0.0.1:8000/users/me",{headers:{Authorization:"Bearer ".concat(e)}});J(t.data.user)}catch(e){console.error("Error fetching current user:",e)}})()},[]),(0,o.useEffect)(()=>{((null==H?void 0:H._id)||(null==H?void 0:H.post_id)||!t)&&(async()=>{try{let e=localStorage.getItem("token"),a=await l.A.get("http://127.0.0.1:8000/posts/".concat(H.post_id||H._id||t,"/comments"),{headers:{Authorization:"Bearer ".concat(e)}});if(Q(a.data),q){let e={},t={};a.data.forEach(a=>{var r,o;e[a.comment_id]=null===(r=a.liked_by)||void 0===r?void 0:r.includes(q.user_id),t[a.comment_id]=null!==(o=a.likes)&&void 0!==o?o:0}),Z(e),ee(t)}}catch(e){console.error("Error fetching comments:",e)}})()},[H,t,q]);let ej=(e,t)=>{Q(a=>a.map(a=>a.comment_id===e?{...a,content:t}:a)),U(a=>{let r={...a};return Object.keys(r).forEach(a=>{var o;r[a]=null===(o=r[a])||void 0===o?void 0:o.map(a=>a.comment_id===e?{...a,content:t}:a)}),r})},ew=e=>{Q(t=>t.filter(t=>t.comment_id!==e)),U(t=>{let a={...t};return Object.keys(a).forEach(t=>{var r;a[t]=null===(r=a[t])||void 0===r?void 0:r.filter(t=>t.comment_id!==e)}),a})};return(0,r.jsxs)("div",{className:"w-full h-screen bg-gray-100 flex flex-col items-center p-4",children:[(0,r.jsxs)("div",{className:"min-w-xl flex items-center justify-between gap-4 mb-4",children:[(0,r.jsx)(n,{size:24,className:"cursor-pointer",onClick:()=>window.history.back()}),(0,r.jsx)("h1",{className:"text-xl font-bold mb-4",children:"B\xecnh luận"}),(0,r.jsx)("div",{})]}),(0,r.jsx)("div",{className:"max-w-xl w-full h-auto",children:(0,r.jsxs)("div",{className:"bg-white rounded-2xl shadow-md p-4 space-y-4",children:[(0,r.jsxs)("div",{className:"border-b pb-4",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("img",{src:(null==W?void 0:W.avatar)?"http://127.0.0.1:8000/media/".concat(W.avatar):"https://placehold.co/40x40",alt:"Avatar",className:"w-10 h-10 rounded-full"}),(0,r.jsxs)("div",{children:[(0,r.jsx)(p(),{href:"/profile/".concat(null==W?void 0:W.user_id),children:(0,r.jsx)("p",{className:"text-sm font-semibold text-black hover:underline cursor-pointer",children:(null==W?void 0:W.username)||"username"})}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:(null==H?void 0:H.created_at)?eb(H.created_at):"time"})]})]}),(0,r.jsx)("p",{className:"mt-2",children:(null==H?void 0:H.content)||"content"}),(null==H?void 0:H.image)&&(0,r.jsx)("img",{src:H.image,alt:"Post",className:"mt-2 rounded-lg"}),(0,r.jsxs)("div",{className:"flex gap-4 text-gray-500 mt-3",children:[(0,r.jsx)(g,{icon:(0,r.jsx)(i.A,{size:18,className:j?"text-red-500":"text-gray-500"}),count:k,onClick:ex}),(0,r.jsx)(g,{icon:(0,r.jsx)(c.A,{size:18}),count:null!==(e=null==H?void 0:H.comments)&&void 0!==e?e:0,onClick:()=>{}}),(0,r.jsx)(g,{icon:(0,r.jsx)(d.A,{size:18,className:N?"text-green-500":"text-gray-500"}),count:C,onClick:eg})]})]}),(0,r.jsxs)("div",{className:"space-y-4 overflow-y-auto p-2 max-h-[440px]",children:[0===K.length&&(0,r.jsx)("div",{className:"text-gray-400 text-sm",children:"Chưa c\xf3 b\xecnh luận n\xe0o."}),K.map(e=>(0,r.jsx)(v,{cmt:e,currentUser:q,commentLikes:Y,commentLikeCounts:$,handleLikeComment:ey,showInputReply:M,toggleReplyInput:ep,replyInputs:P,setReplyInputs:D,handleReplySubmit:ev,replyReplies:F,fetchReplies:ef,formatTime:eb,onEditComment:ej,onDeleteComment:ew,showMedia:es,setShowMedia:el,replyImages:en,setReplyImages:ei,replyVideos:ec,setReplyVideos:ed},e.comment_id||e._id))]}),(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("img",{src:(null==q?void 0:q.avatar)?"http://127.0.0.1:8000/media/".concat(q.avatar):"https://placehold.co/40x40",alt:"Avatar",className:"w-10 h-10 rounded-full"}),(0,r.jsx)("input",{type:"text",placeholder:"Viết b\xecnh luận...",className:"flex-1 p-2 border rounded-lg focus:outline-none",value:a,onChange:e=>h(e.target.value)}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("label",{className:"cursor-pointer",children:[(0,r.jsx)(m.A,{size:20,className:"hover:text-black"}),(0,r.jsx)("input",{type:"file",accept:"image/*",style:{display:"none"},onChange:e=>{var t;ea((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)}})]}),(0,r.jsxs)("label",{className:"cursor-pointer",children:[(0,r.jsx)(u.A,{size:20,className:"hover:text-black"}),(0,r.jsx)("input",{type:"file",accept:"video/*",style:{display:"none"},onChange:e=>{var t;eo((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)}})]}),et&&(0,r.jsxs)("div",{className:"relative w-10 h-10",children:[(0,r.jsx)("img",{src:URL.createObjectURL(et),alt:"preview",className:"w-10 h-10 object-cover rounded"}),(0,r.jsx)("button",{type:"button",className:"absolute top-0 right-0 bg-white rounded-full p-0.5 text-xs text-red-500 border border-gray-300 hover:bg-gray-200",onClick:()=>ea(null),children:"\xd7"})]}),er&&(0,r.jsxs)("div",{className:"relative w-16 h-10",children:[(0,r.jsx)("video",{src:URL.createObjectURL(er),className:"w-16 h-10 object-cover rounded",controls:!0}),(0,r.jsx)("button",{type:"button",className:"absolute top-0 right-0 bg-white rounded-full p-0.5 text-xs text-red-500 border border-gray-300 hover:bg-gray-200",onClick:()=>eo(null),children:"\xd7"})]})]}),(0,r.jsx)("button",{className:"bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold",onClick:async()=>{await eh(),h("")},children:"Đăng"})]}),em&&(0,r.jsx)("div",{className:"text-red-500 text-xs mt-1",children:em})]})})]})}function g(e){let{icon:t,count:a,onClick:o}=e;return(0,r.jsxs)("button",{onClick:o,className:"flex items-center space-x-1 text-gray-500 hover:text-black",children:[t,(0,r.jsx)("span",{className:"text-sm",children:a})]})}function v(e){var t,a,s;let{cmt:n,currentUser:d,commentLikes:h,commentLikeCounts:p,handleLikeComment:x,showInputReply:y,toggleReplyInput:f,replyInputs:b,setReplyInputs:j,handleReplySubmit:w,replyReplies:k,fetchReplies:_,formatTime:N,depth:S=0,onEditComment:C,onDeleteComment:A,showMedia:E,setShowMedia:I,replyImages:z,setReplyImages:R,replyVideos:L,setReplyVideos:B}=e,[T,O]=(0,o.useState)(!1),[F,U]=(0,o.useState)(n.content),[P,D]=(0,o.useState)(null);(0,o.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("token"),t=await l.A.get("http://127.0.0.1:8000/users/".concat(n.user_id),{headers:{Authorization:"Bearer ".concat(e)}});D(t.data.user)}catch(e){console.error("Error fetching comment user:",e)}})()},[n.user_id]);let M=async()=>{try{let e=localStorage.getItem("token"),t=new FormData;t.append("content",F);let a=await fetch("http://127.0.0.1:8000/comments/".concat(n.comment_id),{method:"PUT",headers:{Authorization:"Bearer ".concat(e)},body:t});if(!a.ok)throw Error("Failed to edit comment");let r=await a.json();O(!1),C&&C(n.comment_id,r.content)}catch(e){console.error("Error editing comment:",e)}},V=async()=>{if(window.confirm("Bạn c\xf3 chắc muốn x\xf3a b\xecnh luận n\xe0y?"))try{let e=localStorage.getItem("token");if(!(await fetch("http://127.0.0.1:8000/comments/".concat(n.comment_id),{method:"DELETE",headers:{Authorization:"Bearer ".concat(e)}})).ok)throw Error("Failed to delete comment");A&&A(n.comment_id)}catch(e){console.error("Error deleting comment:",e)}};return(0,r.jsxs)("div",{style:{marginLeft:10*S,maxWidth:"100%"},className:"flex flex-col items-start mt-2 border-b pb-2 w-full",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 w-full",children:[(0,r.jsx)("img",{src:(null==P?void 0:P.avatar)?"http://127.0.0.1:8000/media/".concat(P.avatar):"https://placehold.co/40x40",alt:"Avatar",className:"w-8 h-8 rounded-full"}),(0,r.jsx)("span",{className:"font-semibold text-sm",children:(null==P?void 0:P.username)||"user"}),(0,r.jsx)("span",{className:"text-xs text-gray-400",children:n.created_at?N(n.created_at):"--"}),(null==d?void 0:d.user_id)===n.user_id&&(0,r.jsx)("div",{className:"ml-auto flex gap-2",children:!T&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{className:"text-blue-500 text-xs",onClick:()=>O(!0),children:"Sửa"}),(0,r.jsx)("button",{className:"text-red-500 text-xs",onClick:V,children:"X\xf3a"})]})})]}),(0,r.jsxs)("div",{className:"flex-1 w-full",children:[T?(0,r.jsxs)("div",{className:"flex gap-2 w-full mt-1",children:[(0,r.jsx)("input",{type:"text",className:"flex-1 p-2 border rounded-lg text-sm",value:F,onChange:e=>U(e.target.value)}),(0,r.jsx)("button",{className:"bg-blue-500 text-white px-2 py-1 rounded text-xs",onClick:M,children:"Lưu"}),(0,r.jsx)("button",{className:"bg-gray-300 text-black px-2 py-1 rounded text-xs",onClick:()=>{O(!1),U(n.content)},children:"Hủy"})]}):(0,r.jsx)("div",{className:"text-sm mt-1 break-words",children:n.content}),n.image_id&&(0,r.jsx)("img",{src:"http://127.0.0.1:8000/media/".concat(n.image_id),alt:"Comment",className:"mt-2 rounded-lg"}),n.video_id&&(0,r.jsx)("video",{src:"http://127.0.0.1:8000/media/".concat(n.video_id,"?is_image=false"),controls:!0,className:"mt-2 rounded-lg w-full"})]}),(0,r.jsxs)("div",{className:"flex gap-4 text-gray-500 mt-3",children:[(0,r.jsx)(g,{icon:(0,r.jsx)(i.A,{size:18,className:h[n.comment_id]?"text-red-500":"text-gray-500"}),count:null!==(a=p[n.comment_id])&&void 0!==a?a:0,onClick:()=>x(n.comment_id)}),(0,r.jsx)(g,{icon:(0,r.jsx)(c.A,{size:18}),count:null!==(s=n.replies)&&void 0!==s?s:0,onClick:async()=>{f(n.comment_id),k[n.comment_id]||await _(n.comment_id)}})]}),y[n.comment_id]&&(null===(t=k[n.comment_id])||void 0===t?void 0:t.map(e=>(0,r.jsx)(v,{cmt:{...e,created_at:e.created_at||e.createdAt||e.timestamp},currentUser:d,commentLikes:h,commentLikeCounts:p,handleLikeComment:x,showInputReply:y,toggleReplyInput:f,replyInputs:b,setReplyInputs:j,handleReplySubmit:w,replyReplies:k,fetchReplies:_,formatTime:N,depth:S+1,onEditComment:C,onDeleteComment:A,showMedia:E,setShowMedia:I,replyImages:z,setReplyImages:R,replyVideos:L,setReplyVideos:B},e.comment_id||e._id||e.id))),y[n.comment_id]&&(0,r.jsxs)("div",{className:"flex items-start space-x-2 mt-2 w-[90%]",children:[(0,r.jsx)("img",{src:(null==d?void 0:d.avatar)?"http://127.0.0.1:8000/media/".concat(d.avatar):"https://placehold.co/32x32",alt:"Avatar",className:"w-8 h-8 rounded-full"}),(0,r.jsx)("input",{type:"text",className:"flex-1 p-2 border rounded-lg text-sm",placeholder:"Trả lời b\xecnh luận...",value:b[n.comment_id]||"",onChange:e=>j(t=>({...t,[n.comment_id]:e.target.value}))}),(0,r.jsxs)("label",{className:"cursor-pointer",children:[(0,r.jsx)(m.A,{size:20,className:"hover:text-black"}),(0,r.jsx)("input",{type:"file",accept:"image/*",style:{display:"none"},onChange:e=>{var t;let a=(null===(t=e.target.files)||void 0===t?void 0:t[0])||null;R(e=>({...e,[n.comment_id]:a}))}})]}),(0,r.jsxs)("label",{className:"cursor-pointer",children:[(0,r.jsx)(u.A,{size:20,className:"hover:text-black"}),(0,r.jsx)("input",{type:"file",accept:"video/*",style:{display:"none"},onChange:e=>{var t;let a=(null===(t=e.target.files)||void 0===t?void 0:t[0])||null;B(e=>({...e,[n.comment_id]:a}))}})]}),z[n.comment_id]&&(0,r.jsxs)("div",{className:"relative w-10 h-10 ml-1",children:[(0,r.jsx)("img",{src:URL.createObjectURL(z[n.comment_id]),alt:"preview",className:"w-10 h-10 object-cover rounded"}),(0,r.jsx)("button",{type:"button",className:"absolute top-0 right-0 bg-white rounded-full p-0.5 text-xs text-red-500 border border-gray-300 hover:bg-gray-200",onClick:()=>R(e=>({...e,[n.comment_id]:null})),children:"\xd7"})]}),L[n.comment_id]&&(0,r.jsxs)("div",{className:"relative w-16 h-10 ml-1",children:[(0,r.jsx)("video",{src:URL.createObjectURL(L[n.comment_id]),className:"w-16 h-10 object-cover rounded",controls:!0}),(0,r.jsx)("button",{type:"button",className:"absolute top-0 right-0 bg-white rounded-full p-0.5 text-xs text-red-500 border border-gray-300 hover:bg-gray-200",onClick:()=>B(e=>({...e,[n.comment_id]:null})),children:"\xd7"})]}),(0,r.jsx)("button",{className:"bg-blue-500 text-white px-3 py-1 rounded-lg text-sm",onClick:()=>w(n.post_id,n.comment_id),children:"Gửi"})]})]})}},7213:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});let r=(0,a(9946).A)("image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]])},9803:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});let r=(0,a(9946).A)("video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]])}},e=>{var t=t=>e(e.s=t);e.O(0,[244,324,441,684,358],()=>t(4845)),_N_E=e.O()}]);